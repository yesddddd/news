var _userId;
var _ssoId;
var freePaperName;
var paidPaperName;
var scannext = false;
var _href = window.location.href;
var pattern = /[0-9]{6}\/[0-9]{2}/;
var curdate = _href.match(pattern);
var paperLayout = _href.substr(-7,2);  
var checkUser = {
	init: function() {
		_userId = doGetCookie("username_fouNder");
		_ssoId = doGetCookie("mid_fouNder");
		paperName = $(".paperName").html();
		$(".exit, #sso-active a, .btnClose").on('click', function(e) {
			e.stopPropagation();
			$(".screen ,.tipMsg").hide();
			return false;
		})
		this.judgeOrder();
	},
	judgeOrder: function() { //判断登录用户是否购买此订单
		$.ajax({
			type: "get",
			url: pageUrl + "amuc/api/read/permission/user",
			async: true,
			data: {
				"uid": _ssoId
			},
			success: function(datas) {
				var curPaperName = $(".paperName").text();
				var newPaperName = $(".newPaperName").text();
				var curTime = $("#paperdate").text();
				var newCurTime = curTime.replace(/[^\x00-\xff]/g, '-').substr(0, 10);
				var needGoon = false;
				
				var free = datas.free;
				var paid = datas.paid;
				var member = datas.isMember;
//				var freeMember = datas.isFreeMember;
				var freeMember = false;
				
				for(var i in datas) {
					//判断是否是免费报纸
//					for(var j in free) {
//						var isFree = true;
//						if(free[j].paperName == curPaperName) {
//							scannext = true;
//							break;
//						}
//
//					}
					
//					if(scannext) break;
					
					for(var k in paid) {
						if(paid[k].paperName == curPaperName || paid[k].paperName == newPaperName) {
							scannext = true;
							break;
						}
					}
					if(scannext) break;
					
				}
				
				checkUser.setPerssion(freeMember, curPaperName,member);
			}
		});
	},
	setPerssion: function(freeMember, curPaperName, member, isFree) {
		var canRead = false;
		if(freeMember){
			canRead = true;
			checkUser.canReadPaper();
			if(canRead) {
				return true;
			}
		}else{
			if(member) {
				if(scannext) {
					canRead = true;
					checkUser.canReadPaper();
					if(canRead) {
						return true;
					}
	
				} else {
					$(".newslist li a").on('click', function() {
						$(this).attr("href", "javascript:void(0)");
						$(".screen, .tipMsg").show();
					})
					$(".mark").show();
					/*
					$("body").css("overflow", 'hidden');
					*/
					$('.mark').on('click', function() {
						$(".screen ,.tipMsg").show();
					})
					$(".buyBtn,.payBtn").on('click', function() {
						window.location.href = ''+ pageUrl  +'amucsite/pcColfees/putOrder.html'+ "?curdate="+ curdate + "&paperLayout=" + paperLayout+"&title="+ encodeURI(doGetCookie("title_fouNder"));
					});
					$(".activBtn,.activeBtn").on('click', function() {
						$(".dialog").show();
						$(".tipMsg").hide();
						$(".screen").show();
					})
					$(".buyPaper").click(function() {
						window.location.href = ''+ ssourl +'user/ssoLogin?code=szb&redirectUrl=http://sso2.aqsc.cn/sso/setCookie.html?&anyUrl='+ pageUrl  +'amucsite/pcColfees/putOrder.html'
					});
					$(".activePaper").click(function() {
						window.location.href = ''+ ssourl +'user/ssoLogin?code=szb&redirectUrl=http://paper.aqsc.cn/sso/setCookie.html?&anyUrl='+ pageUrl  +'amucsite/pcColfees/myOrder.html'
					})
					checkUser.forbiddenUrl();
					
				}
			} else {
				$(".mark").show();
				/*
				$("body").css("overflow", 'hidden');
				*/
				$('.mark').click(function() {
					$(".screen,.tipMsg").show();
				})
				$(".buyBtn,.activBtn,.buyPaper,.activePaper,.activeBtn,.payBtn").on('click', function() {
					window.location.href = ''+ ssourl +'user/ssoLogin?code=szb&redirectUrl=http://paper.aqsc.cn/sso/setCookie.html?&anyUrl='+ userUrl + curdate +'/'+ paper + paperLayout +'.html';
				})
				$(".newslist li a").on('click', function() {
					$(this).attr("href", "javascript:void(0)");
					$(".screen, .tipMsg").show();
				});
				checkUser.forbiddenUrl();
			}
		}
	},
	canReadPaper: function(){
		$(".newslist li a").on('click', function() {
			var _this = $(this);
			var src = "";
			var hasClick = _this.attr("data-click");
			if(!hasClick) {
				src = _this.attr("href");
				_this.attr("href", "javascript:void(0)");
				_this.attr("data-click", "true");
				_this.attr("data-href", src);
	
			} else {
				src = _this.attr("data-href");
			}
			$(".newsconright").css("padding", "40px 0 0 0");
			$(".articleContent").show();
			$(".newslist ul li").hide();
			$(".backlist").show();
			$(".articleContent .articles").attr("src", src);
		});
		$(".mark, .tipMsg, .screen").hide();
		$("body").css("overflow", 'auto');
		$(".payBtn").on('click', function() {
			window.location.href = ''+ pageUrl  +'amucsite/pcColfees/putOrder.html'+ "?curdate="+ curdate + "&paperLayout=" + paperLayout+"&title="+encodeURI(doGetCookie("title_fouNder"));
		});
		$(".activeBtn").on('click', function() {
			$(".dialog").show();
			$(".tipMsg").hide();
			$(".screen").show();
		})
		
	},
	forbiddenUrl:function(){
		$.each($(".Chunkiconlist p"), function() {    
			$(this).find('a').eq(0).attr('href','javascript:void(0)');
			$(this).find('a').eq(1).attr('href','javascript:void(0)');
		});
	}
}

$(function() {
	checkUser.init();
})